<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <title>言葉のプラネタリウム</title>
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.rawgit.com/jeromeetienne/AR.js/2.2.1/aframe/build/aframe-ar.js"></script>
    <script src="https://cdn.jsdelivr.net/gh/protyze/aframe-look-at-component/dist/aframe-look-at-component.min.js"></script>
  </head>
  <body style="margin: 0; overflow: hidden;">
    <a-scene
      arjs="trackingMethod: best; sourceType: webcam; sourceWidth: 640; sourceHeight: 480; debugUIEnabled: false;"
      vr-mode-ui="enabled: false"
      renderer="alpha: true; antialias: true; logarithmicDepthBuffer: true"
    >
      <a-camera id="mainCamera" position="0 1.6 0"></a-camera>
    </a-scene>

    <script>
      // モデルリスト
      const maxModels = 100;
      const words = [];
      for (let i = 1; i <= maxModels; i++) {
        words.push(`models/word${i}.glb`);
      }

      function spawnWord() {
        const scene = document.querySelector("a-scene");
        const camera = document.getElementById("mainCamera");
        const model = document.createElement("a-entity");

        // ランダムにモデルを選ぶ
        const choice = words[Math.floor(Math.random() * words.length)];

        // カメラの現在地を取得
        const cameraPos = camera.getAttribute('position');

        // カメラ中心の円周上に配置
        const radius = 2.5 + Math.random() * 2.0; // 半径2.5〜4.5m
        const angle = Math.random() * Math.PI * 2; // 0〜360度

        // ワールド座標へのオフセットを計算
        const dx = Math.cos(angle) * radius;
        const dz = Math.sin(angle) * radius;

        // カメラの現在地にオフセットを加算して、ワールド座標を決定
        const x = (cameraPos.x + dx).toFixed(2);
        const z = (cameraPos.z + dz).toFixed(2);
        
        // Y座標設定
        const startY = 8;
        // ★ 変更点: 終点 Y座標を -0.5 に変更 (より床下で消える)
        const endY = -0.5; 
        const duration = 12000;
        const removalTime = duration + 1000;

        model.setAttribute("gltf-model", `url(${choice})`);
        model.setAttribute("scale", "0.6 0.6 0.6");
        model.setAttribute("position", `${x} ${startY} ${z}`);
        
        // ★ 変更点なし: look-at で常にカメラの方を向かせる (念のため再確認)
        model.setAttribute("look-at", "#mainCamera"); 

        // 落下アニメーション
        model.setAttribute(
          "animation",
          `property: position; to: ${x} ${endY} ${z}; dur: ${duration}; easing: linear; loop: false`
        );

        scene.appendChild(model);

        // 削除（メモリ節約）
        setTimeout(() => model.remove(), removalTime);
      }

      // 0.8秒ごとに文字を生成
      window.onload = () => {
        setInterval(spawnWord, 800);
      };
    </script>
  </body>
</html>
